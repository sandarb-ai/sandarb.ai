name: sandarb-kafka-cluster

networks:
  kafka-net:
    driver: bridge

volumes:
  broker01_data:
  broker02_data:
  broker03_data:
  broker04_data:
  broker05_data:

services:
  broker01:
    image: apache/kafka:latest
    container_name: sandarb-broker01
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_LISTENERS=PLAINTEXT://:9090,CONTROLLER://:9091,EXTERNAL://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker01:9090,EXTERNAL://localhost:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker01:9091,2@broker02:9091,3@broker03:9091
      # KRaft requires a Cluster ID. We hardcode one here for convenience.
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - broker01_data:/var/lib/kafka/data
    networks:
      - kafka-net

  broker02:
    image: apache/kafka:latest
    container_name: sandarb-broker02
    ports:
      - "9093:9093"
    environment:
      - KAFKA_NODE_ID=2
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_LISTENERS=PLAINTEXT://:9090,CONTROLLER://:9091,EXTERNAL://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker02:9090,EXTERNAL://localhost:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker01:9091,2@broker02:9091,3@broker03:9091
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - broker02_data:/var/lib/kafka/data
    networks:
      - kafka-net

  broker03:
    image: apache/kafka:latest
    container_name: sandarb-broker03
    ports:
      - "9094:9094"
    environment:
      - KAFKA_NODE_ID=3
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_LISTENERS=PLAINTEXT://:9090,CONTROLLER://:9091,EXTERNAL://:9094
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker03:9090,EXTERNAL://localhost:9094
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker01:9091,2@broker02:9091,3@broker03:9091
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - broker03_data:/var/lib/kafka/data
    networks:
      - kafka-net

  broker04:
    image: apache/kafka:latest
    container_name: sandarb-broker04
    ports:
      - "9095:9095"
    environment:
      - KAFKA_NODE_ID=4
      - KAFKA_PROCESS_ROLES=broker
      - KAFKA_LISTENERS=PLAINTEXT://:9090,EXTERNAL://:9095
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker04:9090,EXTERNAL://localhost:9095
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker01:9091,2@broker02:9091,3@broker03:9091
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - broker04_data:/var/lib/kafka/data
    networks:
      - kafka-net

  broker05:
    image: apache/kafka:latest
    container_name: sandarb-broker05
    ports:
      - "9096:9096"
    environment:
      - KAFKA_NODE_ID=5
      - KAFKA_PROCESS_ROLES=broker
      - KAFKA_LISTENERS=PLAINTEXT://:9090,EXTERNAL://:9096
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker05:9090,EXTERNAL://localhost:9096
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker01:9091,2@broker02:9091,3@broker03:9091
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - broker05_data:/var/lib/kafka/data
    networks:
      - kafka-net

  # ── Topic initializer (runs once, creates all Sandarb topics) ──
  topic-init:
    image: apache/kafka:latest
    container_name: sandarb-topic-init
    depends_on:
      - broker01
      - broker02
      - broker03
    restart: "no"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for Kafka brokers to be ready..."
        sleep 10
        BOOTSTRAP="broker01:9090"
        TOPICS=(
          "sandarb_events"
          "sandarb.inject"
          "sandarb.audit"
          "sandarb.agent-lifecycle"
          "sandarb.governance-proof"
          "sandarb.context-lifecycle"
          "sandarb.prompt-lifecycle"
          "sandarb.policy-violations"
        )
        for topic in "$${TOPICS[@]}"; do
          /opt/kafka/bin/kafka-topics.sh --create \
            --bootstrap-server $$BOOTSTRAP \
            --topic "$$topic" \
            --partitions 6 \
            --replication-factor 3 \
            --if-not-exists 2>&1
          echo "  $$topic -> created"
        done
        echo ""
        echo "All Sandarb topics:"
        /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server $$BOOTSTRAP 2>/dev/null | grep sandarb
        echo "Topic initialization complete."
    networks:
      - kafka-net
