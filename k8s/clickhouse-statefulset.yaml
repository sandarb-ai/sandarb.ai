# ClickHouse Cluster — 1 shard × 2 replicas + 3 ClickHouse Keepers
# Minimal GKE topology for dev/staging.
#
# Keeper ensemble (3 nodes) provides HA coordination for replication.
# Nodes discover each other via headless Service DNS:
#   sandarb-clickhouse-{0..1}.sandarb-clickhouse-nodes.sandarb-data.svc.cluster.local
#   sandarb-clickhouse-keeper-{0..2}.sandarb-clickhouse-keeper.sandarb-data.svc.cluster.local
#
# Total CPU request: 2×500m (CH) + 3×200m (Keeper) = 1.6 vCPU
---
# ClickHouse Keeper ensemble (3 nodes — replaces ZooKeeper)
apiVersion: v1
kind: Service
metadata:
  name: sandarb-clickhouse-keeper
  namespace: sandarb-data
  labels:
    app: sandarb-clickhouse-keeper
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: sandarb-clickhouse-keeper
  ports:
    - name: keeper
      port: 9181
      targetPort: 9181
    - name: raft
      port: 9234
      targetPort: 9234
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sandarb-clickhouse-keeper
  namespace: sandarb-data
  labels:
    app: sandarb-clickhouse-keeper
spec:
  serviceName: sandarb-clickhouse-keeper
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: sandarb-clickhouse-keeper
  template:
    metadata:
      labels:
        app: sandarb-clickhouse-keeper
    spec:
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 101
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command: ["sh", "-c", "rm -rf /var/lib/clickhouse-keeper/lost+found && chown -R 101:101 /var/lib/clickhouse-keeper"]
          volumeMounts:
            - name: keeper-data
              mountPath: /var/lib/clickhouse-keeper
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
        # Generate keeper config from pod ordinal for 3-node ensemble
        - name: init-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              ORDINAL=${HOSTNAME##*-}
              SERVER_ID=$((ORDINAL + 1))
              cat > /etc/clickhouse-keeper/keeper_config.xml <<EOF
              <clickhouse>
                <listen_host>0.0.0.0</listen_host>
                <keeper_server>
                  <tcp_port>9181</tcp_port>
                  <server_id>${SERVER_ID}</server_id>
                  <log_storage_path>/var/lib/clickhouse-keeper/coordination/log</log_storage_path>
                  <snapshot_storage_path>/var/lib/clickhouse-keeper/coordination/snapshots</snapshot_storage_path>
                  <coordination_settings>
                    <operation_timeout_ms>10000</operation_timeout_ms>
                    <session_timeout_ms>30000</session_timeout_ms>
                    <raft_logs_level>warning</raft_logs_level>
                  </coordination_settings>
                  <raft_configuration>
                    <server>
                      <id>1</id>
                      <hostname>sandarb-clickhouse-keeper-0.sandarb-clickhouse-keeper.sandarb-data.svc.cluster.local</hostname>
                      <port>9234</port>
                    </server>
                    <server>
                      <id>2</id>
                      <hostname>sandarb-clickhouse-keeper-1.sandarb-clickhouse-keeper.sandarb-data.svc.cluster.local</hostname>
                      <port>9234</port>
                    </server>
                    <server>
                      <id>3</id>
                      <hostname>sandarb-clickhouse-keeper-2.sandarb-clickhouse-keeper.sandarb-data.svc.cluster.local</hostname>
                      <port>9234</port>
                    </server>
                  </raft_configuration>
                </keeper_server>
              </clickhouse>
              EOF
              sed -i 's/^[[:space:]]*//' /etc/clickhouse-keeper/keeper_config.xml
              chown 101:101 /etc/clickhouse-keeper/keeper_config.xml
              echo "Keeper config (server_id=${SERVER_ID}):"
              cat /etc/clickhouse-keeper/keeper_config.xml
          volumeMounts:
            - name: keeper-config
              mountPath: /etc/clickhouse-keeper
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
      containers:
        - name: keeper
          image: clickhouse/clickhouse-keeper:latest
          ports:
            - containerPort: 9181
              name: keeper
            - containerPort: 9234
              name: raft
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          readinessProbe:
            tcpSocket:
              port: 9181
            initialDelaySeconds: 15
            periodSeconds: 10
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: 9181
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 10
          volumeMounts:
            - name: keeper-config
              mountPath: /etc/clickhouse-keeper
            - name: keeper-data
              mountPath: /var/lib/clickhouse-keeper
      volumes:
        - name: keeper-config
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: keeper-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: premium-rwo
        resources:
          requests:
            storage: 1Gi
---
# ClickHouse Nodes — headless Service for inter-node discovery
apiVersion: v1
kind: Service
metadata:
  name: sandarb-clickhouse-nodes
  namespace: sandarb-data
  labels:
    app: sandarb-clickhouse
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: sandarb-clickhouse
  ports:
    - name: http
      port: 8123
      targetPort: 8123
    - name: native
      port: 9000
      targetPort: 9000
---
# ClickHouse client-facing Service (load-balanced across 2 nodes)
apiVersion: v1
kind: Service
metadata:
  name: sandarb-clickhouse
  namespace: sandarb-data
  labels:
    app: sandarb-clickhouse
spec:
  selector:
    app: sandarb-clickhouse
  ports:
    - name: http
      port: 8123
      targetPort: 8123
    - name: native
      port: 9000
      targetPort: 9000
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sandarb-clickhouse
  namespace: sandarb-data
  labels:
    app: sandarb-clickhouse
spec:
  serviceName: sandarb-clickhouse-nodes
  replicas: 2
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: sandarb-clickhouse
  template:
    metadata:
      labels:
        app: sandarb-clickhouse
    spec:
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 101
      initContainers:
        # Fix PVC ownership for ClickHouse (runs as uid 101)
        - name: fix-permissions
          image: busybox:1.36
          command: ["sh", "-c", "rm -rf /var/lib/clickhouse/lost+found && chown -R 101:101 /var/lib/clickhouse"]
          volumeMounts:
            - name: data
              mountPath: /var/lib/clickhouse
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
        # Copy the correct macros file based on pod ordinal
        - name: init-macros
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              ORDINAL=${HOSTNAME##*-}
              cp /config-templates/macros_node${ORDINAL}.xml /etc/clickhouse-server/config.d/macros.xml
              cp /config-templates/cluster_config.xml /etc/clickhouse-server/config.d/cluster_config.xml
          volumeMounts:
            - name: config-templates
              mountPath: /config-templates
            - name: config
              mountPath: /etc/clickhouse-server/config.d
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
      containers:
        - name: clickhouse
          image: clickhouse/clickhouse-server:latest
          ports:
            - containerPort: 8123
              name: http
            - containerPort: 9000
              name: native
          env:
            - name: CLICKHOUSE_USER
              value: "default"
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sandarb-data-secrets
                  key: clickhouse-password
            - name: CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT
              value: "1"
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "2Gi"
          readinessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 30
            periodSeconds: 15
          volumeMounts:
            - name: config
              mountPath: /etc/clickhouse-server/config.d
            - name: data
              mountPath: /var/lib/clickhouse
      volumes:
        - name: config-templates
          configMap:
            name: sandarb-clickhouse-config
        - name: config
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: premium-rwo
        resources:
          requests:
            storage: 1Gi
